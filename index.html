<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Новый год 2026 — Вход с кодом</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#0a001f;color:#fff;height:100vh;overflow:hidden;font-family:Arial}
    .stars{position:fixed;inset:0;background:url('https://assets.codepen.io/1538474/stars.png');animation:t 8s infinite}
    @keyframes t{0%,100%{opacity:.7}50%{opacity:1}}
    .aurora{position:fixed;top:0;width:100%;height:40%;background:linear-gradient(90deg,#00f260,#0575e6,#a166ab,#f093fb);opacity:.3;filter:blur(80px);animation:a 20s infinite alternate}
    @keyframes a{0%{transform:translateX(-20%)}100%{transform:translateX(20%)}}
    .snow{position:fixed;inset:0;pointer-events:none}
    .snow div{position:absolute;color:#fff;font-size:1.5em;animation:s linear infinite}
    @keyframes s{to{transform:translateY(100vh) rotate(360deg)}}
    .page{position:fixed;inset:0;transition:opacity 1.5s;opacity:0;z-index:-1}
    .page.active{opacity:1;z-index:10}
    .card{background:rgba(10,0,40,.8);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.1);border-radius:20px;max-width:450px}
    .btn-gold{background:linear-gradient(45deg,#ffd700,#ffb347);border:none;color:#000;font-weight:bold}
    .magic-title{font-size:5rem;background:linear-gradient(45deg,#ffd700,#fff,#87CEEB);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 40px gold;animation:g 3s infinite}
    @keyframes g{0%{text-shadow:0 0 40px gold}100%{text-shadow:0 0 80px #fff}}
    .tree{width:220px;height:320px;background:conic-gradient(from 0deg at 50% 10%,#0f0 0deg,#0c0 30deg,#090 60deg,transparent 90deg);border-radius:50% 50% 50% 50% / 60% 60% 40% 40%;position:relative;animation:tr 4s infinite}
    .tree::before{content:"★";position:absolute;top:-35px;left:50%;transform:translateX(-50%);font-size:70px;color:gold;animation:st 3s infinite}
    @keyframes tr{0%,100%{filter:brightness(1)}50%{filter:brightness(1.6)}}
    @keyframes st{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.3)}}
    @media(max-width:768px){.magic-title{font-size:3rem}}
  </style>
</head>
<body>

  <!-- 1. Email + пароль -->
  <div id="auth" class="page active d-flex align-items-center justify-content-center">
    <div class="stars"></div>
    <div class="card shadow-lg p-5 text-center">
      <h1 style="color:#ffd700;font-size:3rem">Новый год близко</h1>
      <p class="mb-4">Вход или регистрация</p>
      <input type="email" id="email" class="form-control form-control-lg mb-3" placeholder="Email">
      <input type="password" id="pass" class="form-control form-control-lg mb-3" placeholder="Пароль">
      <button id="loginBtn" class="btn btn-outline-light btn-lg w-100 mb-2">Войти</button>
      <button id="regBtn" class="btn btn-gold btn-lg w-100">Зарегистрироваться</button>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>

  <!-- 2. Код подтверждения -->
  <div id="verify" class="page d-flex align-items-center justify-content-center">
    <div class="stars"></div>
    <div class="card shadow-lg p-5 text-center">
      <h1 style="color:#ffd700;font-size:3rem">Код подтверждения</h1>
      <p class="mb-4">Мы отправили 6-значный код на <strong id="sentEmail"></strong></p>
      <input type="text" id="code" class="form-control form-control-lg text-center mb-3" maxlength="6" placeholder="000000">
      <button id="confirmBtn" class="btn btn-gold btn-lg w-100">Подтвердить</button>
      <div id="msg2" class="mt-3"></div>
    </div>
  </div>

  <!-- 3. Новогодняя магия -->
  <div id="magic" class="page text-center d-flex flex-column justify-content-center align-items-center">
    <div class="snow"></div>
    <div class="aurora"></div>
    <h1 class="magic-title">С НОВЫМ ГОДОМ!</h1>
    <p style="font-size:2.2rem;color:#87CEEB;margin:30px 0">Добро пожаловать в 2026!</p>
    <div class="tree"></div>
  </div>

  <!-- EmailJS для отправки кода -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("WhlYd8sZ7vV3jK1rP"); // можно заменить на свой

    let currentCode = "";
    let currentEmail = "";

    // Генерация кода
    function genCode() { return Math.floor(100000 + Math.random() * 900000).toString(); }

    // Сохранение времени последнего успешного входа
    function saveLastLogin(email) {
      localStorage.setItem('lastLogin_' + btoa(email), Date.now());
    }
    function isRecentLogin(email) {
      const last = localStorage.getItem('lastLogin_' + btoa(email));
      if (!last) return false;
      return (Date.now() - parseInt(last)) < 5 * 60 * 1000; // 5 минут
    }

    // Показ сообщений
    function show(id, text, type = 'danger') {
      document.getElementById(id).innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${text}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    }

    // Загрузка конфига с твоего Cloudflare Worker (ключ скрыт!)
    fetch('https://secret-firebase.denis-krivalts.workers.dev/')
      .then(r => r.json())
      .then(config => {
        firebase.initializeApp(config);
        const auth = firebase.auth();

        // Проверка текущего пользователя
        auth.onAuthStateChanged(user => {
          if (user && isRecentLogin(user.email)) {
            openMagic();
          }
        });

        // Регистрация
        document.getElementById('regBtn').onclick = () => {
          const email = document.getElementById('email').value.trim();
          const pass = document.getElementById('pass').value;
          if (!email || !pass || pass.length < 6) return show('msg', 'Проверьте данные');

          auth.createUserWithEmailAndPassword(email, pass)
            .then(() => sendVerificationCode(email))
            .catch(err => show('msg', err.message));
        };

        // Вход
        document.getElementById('loginBtn').onclick = () => {
          const email = document.getElementById('email').value.trim();
          const pass = document.getElementById('pass').value;
          if (!email || !pass) return show('msg', 'Заполните поля');

          auth.signInWithEmailAndPassword(email, pass)
            .then(user => {
              if (isRecentLogin(email)) {
                openMagic();
              } else {
                sendVerificationCode(email);
              }
            })
            .catch(err => show('msg', err.message));
        };

        // Подтверждение кода
        document.getElementById('confirmBtn').onclick = () => {
          if (document.getElementById('code').value === currentCode) {
            saveLastLogin(currentEmail);
            openMagic();
          } else {
            show('msg2', 'Неверный код');
          }
        };

        // Отправка кода на почту
        function sendVerificationCode(email) {
          currentCode = genCode();
          currentEmail = email;
          document.getElementById('sentEmail').textContent = email;

          emailjs.send("service_8r0iq1b", "template_magic_code", {
            to_email: email,
            code: currentCode
          }).then(() => {
            document.getElementById('auth').classList.remove('active');
            document.getElementById('verify').classList.add('active');
          }).catch(() => show('msg', 'Ошибка отправки кода'));
        }

        function openMagic() {
          document.getElementById('auth').classList.remove('active');
          document.getElementById('verify').classList.remove('active');
          document.getElementById('magic').classList.add('active');
          startSnow();
        }

        function startSnow() {
          const s = document.querySelector('.snow');
          for(let i = 0; i < 180; i++){
            const f = document.createElement('div');
            f.textContent = '❆❅✻*❄'[Math.floor(Math.random()*5)];
            f.style.left = Math.random()*100 + 'vw';
            f.style.animationDuration = 6 + Math.random()*14 + 's';
            f.style.fontSize = (0.8 + Math.random()*1.4) + 'em';
            f.style.opacity = 0.6 + Math.random()*0.4;
            s.appendChild(f);
          }
        }
      });
  </script>
</body>
</html>
